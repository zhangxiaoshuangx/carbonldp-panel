{"version":3,"sources":["my-apps/app-content/security/roles/roles.service.ts"],"names":[],"mappings":"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","file":"roles.service.js","sourcesContent":["import { Injectable } from \"@angular/core\";\n\nimport Carbon from \"carbonldp/Carbon\";\nimport * as App from \"carbonldp/App\";\nimport * as Roles from \"carbonldp/App/Roles\";\nimport * as Role from \"carbonldp/App/Role\";\nimport * as PersistedRole from \"carbonldp/App/PersistedRole\";\nimport * as HTTP from \"carbonldp/HTTP\";\nimport * as Utils from \"carbonldp/Utils\";\nimport * as URI from \"carbonldp/RDF/URI\";\nimport * as NS from \"carbonldp/NS\";\nimport * as SPARQL from \"carbonldp/SPARQL\";\nimport { Class as RetrievalPreferences, OrderByProperty } from \"carbonldp/RetrievalPreferences\";\n\n@Injectable()\nexport class RolesService {\n\n\tcarbon:Carbon;\n\tappContextsRoles:Map<string, Map<string, PersistedRole.Class>>;\n\n\tconstructor( carbon:Carbon ) {\n\t\tthis.carbon = carbon;\n\t\tthis.appContextsRoles = new Map<string, Map<string, PersistedRole.Class>>();\n\t}\n\n\tpublic get( slugOrURI:string, appContext:App.Context ):Promise<PersistedRole.Class> {\n\t\tlet uri:string = appContext.getBaseURI() + `roles/${slugOrURI}/`;\n\t\tif( URI.Util.isAbsolute( slugOrURI ) ) uri = slugOrURI;\n\t\tlet existingRoles:Map <string, PersistedRole.Class> = this.appContextsRoles.get( appContext.getBaseURI() );\n\t\texistingRoles = typeof existingRoles === \"undefined\" ? new Map<string, PersistedRole.Class>() : existingRoles;\n\t\treturn appContext.documents.get<PersistedRole.Class>( uri ).then( ( [ role, response ]:[ PersistedRole.Class, HTTP.Response.Class ] ) => {\n\t\t\texistingRoles.set( role.id, role );\n\t\t\treturn role;\n\t\t} );\n\t}\n\n\tpublic getAll( appContext:App.Context, limit?:number, page?:number, orderBy?:string, ascending:boolean = true ):Promise<PersistedRole.Class[]> {\n\t\tlet uri:string = appContext.getBaseURI() + \"roles/\";\n\t\tlet existingRoles:Map <string, PersistedRole.Class> = this.appContextsRoles.get( appContext.getBaseURI() );\n\t\texistingRoles = typeof existingRoles === \"undefined\" ? new Map<string, PersistedRole.Class>() : existingRoles;\n\n\t\tlet preferences:RetrievalPreferences = {},\n\t\t\tproperty:OrderByProperty,\n\t\t\tname:OrderByProperty = {\n\t\t\t\t\"@id\": NS.CS.Predicate.namae,\n\t\t\t\t\"@type\": \"string\",\n\t\t\t},\n\t\t\temail:OrderByProperty = {\n\t\t\t\t\"@id\": NS.VCARD.Predicate.email,\n\t\t\t\t\"@type\": \"string\",\n\t\t\t},\n\t\t\tcreated:OrderByProperty = {\n\t\t\t\t\"@id\": NS.C.Predicate.created,\n\t\t\t\t\"@type\": \"dateTime\",\n\t\t\t},\n\t\t\tmodified:OrderByProperty = {\n\t\t\t\t\"@id\": NS.C.Predicate.modified,\n\t\t\t\t\"@type\": \"dateTime\",\n\t\t\t};\n\t\tswitch( orderBy ) {\n\t\t\tcase \"name\":\n\t\t\t\tproperty = name;\n\t\t\t\tbreak;\n\t\t\tcase \"email\":\n\t\t\t\tproperty = email;\n\t\t\t\tbreak;\n\t\t\tcase \"created\":\n\t\t\t\tproperty = created;\n\t\t\t\tbreak;\n\t\t\tcase \"modified\":\n\t\t\t\tproperty = modified;\n\t\t\t\tbreak;\n\t\t}\n\t\tif( ! ascending ) property[ \"@id\" ] = \"-\" + property[ \"@id\" ];\n\t\tif( ! ! orderBy ) preferences.orderBy = [ property ];\n\t\tif( typeof limit !== \"undefined\" ) preferences.limit = limit;\n\t\tif( typeof page !== \"undefined\" ) preferences.offset = page * limit;\n\n\t\treturn this.carbon.documents.getChildren<PersistedRole.Class>( uri, preferences ).then( ( [ roles, response ]:[ PersistedRole.Class[], HTTP.Response.Class ] ) => {\n\t\t\troles.filter( ( role:PersistedRole.Class ) => ! existingRoles.has( role.id ) )\n\t\t\t\t.forEach( ( role:PersistedRole.Class ) => existingRoles.set( role.id, role ) );\n\n\t\t\tlet rolesArray:PersistedRole.Class[] = Utils.A.from( existingRoles.values() );\n\t\t\tif( orderBy ) rolesArray = this.getSortedRoles( rolesArray, orderBy, ascending );\n\n\t\t\treturn rolesArray;\n\t\t} );\n\t}\n\n\tpublic create( appContext:App.Context, parentRole:string|PersistedRole.Class, role:PersistedRole.Class, slug?:string ):Promise<PersistedRole.Class> {\n\t\tclass MockedRoles extends Roles.Class {}\n\t\tlet roles:Roles.Class = new MockedRoles( appContext );\n\t\treturn roles.createChild( parentRole, <Role.Class & PersistedRole.Class>role, slug ).then( ( [ role, response ]:[ PersistedRole.Class, HTTP.Response.Class ] ) => {\n\t\t\treturn role;\n\t\t} );\n\t}\n\n\tpublic saveAndRefresh( appContext:App.Context, role:PersistedRole.Class ):Promise<[ PersistedRole.Class, [ HTTP.Response.Class, HTTP.Response.Class ] ]> {\n\t\treturn role.saveAndRefresh();\n\t}\n\n\tpublic registerAgent( appContext:App.Context, agentID:string, roleID:string ):Promise<HTTP.Response.Class> {\n\t\tclass MockedRoles extends Roles.Class {}\n\t\tlet roles:Roles.Class = new MockedRoles( appContext );\n\t\treturn roles.addAgent( roleID, agentID )\n\t}\n\n\tpublic removeAgent( appContext:App.Context, agentID:string, roleID:string ):Promise<HTTP.Response.Class> {\n\t\tclass MockedRoles extends Roles.Class {}\n\t\tlet roles:Roles.Class = new MockedRoles( appContext );\n\t\treturn roles.removeAgent( roleID, agentID )\n\t}\n\n\tpublic getNumberOfRoles( appContext:App.Context ):Promise<number> {\n\t\tlet agentsURI:string = appContext.getBaseURI() + \"roles/\",\n\t\t\tquery:string = `SELECT DISTINCT (COUNT(?role) AS ?count) WHERE {\n\t\t\t?role a <https://carbonldp.com/ns/v1/security#AppRole> . \n\t\t}`;\n\t\treturn appContext.documents.executeSELECTQuery( agentsURI, query ).then( ( [ results, response ]:[ SPARQL.SELECTResults.Class, HTTP.Response.Class ] ) => {\n\t\t\tif( typeof results.bindings[ 0 ] === \"undefined\" ) return 0;\n\t\t\treturn results.bindings[ 0 ][ \"count\" ];\n\t\t} );\n\t}\n\n\tpublic getChildren( appContext:App.Context, roleID?:string ):Promise<PersistedRole.Class[]> {\n\t\tlet rolesURI:string = appContext.getBaseURI() + \"roles/\",\n\t\t\tfilter:string = ! ! roleID ? `EXISTS { ?role <${NS.CS.Predicate.parentRole}> <${roleID}> }` : `NOT EXISTS { ?role <${NS.CS.Predicate.parentRole}> ?parentRole } `,\n\t\t\tquery:string = `\n\t\t\t\tSELECT ?role ?name ?parentRole ?childRole\n\t\t\t\tWHERE{\n\t\t\t\t  GRAPH ?role { \n\t\t\t\t    ?role a <https://carbonldp.com/ns/v1/security#AppRole> .\n\t\t\t\t\t?role <https://carbonldp.com/ns/v1/security#name> ?name .\n\t\t\t\t\tOPTIONAL { ?role <https://carbonldp.com/ns/v1/security#parentRole> ?parentRole } .\n\t\t\t\t  }\n\t\t\t\t  BIND( EXISTS { GRAPH ?role { ?role <https://carbonldp.com/ns/v1/security#childRole> ?childRole } } as ?childRole)\n\t\t\t\t  FILTER( ${filter} )\n\t\t\t\t}`;\n\t\treturn appContext.documents.executeSELECTQuery( rolesURI, query ).then( ( [ results, response ]:[ SPARQL.SELECTResults.Class, HTTP.Response.Class ] ) => {\n\t\t\tlet roles:Role.Class[] = [];\n\t\t\tresults.bindings.forEach( ( rolePointer:SPARQL.SELECTResults.BindingObject ) => {\n\t\t\t\tlet role:Role.Class = Role.Factory.createFrom( { id: rolePointer[ \"role\" ][ \"id\" ] }, <string>rolePointer[ \"name\" ] );\n\t\t\t\trole[ \"hasChildren\" ] = rolePointer[ \"childRole\" ];\n\t\t\t\troles.push( role );\n\t\t\t} );\n\t\t\treturn roles;\n\t\t} );\n\t}\n\n\tprivate getSortedRoles( roles:PersistedRole.Class[], orderBy:string, ascending:boolean ):PersistedRole.Class[] {\n\t\treturn roles.sort( ( roleA, roleB ) => {\n\t\t\tif( typeof roleA[ orderBy ] === \"string\" ) {\n\t\t\t\tif( roleA[ orderBy ].toLowerCase() > roleB[ orderBy ].toLowerCase() ) return ascending ? - 1 : 1;\n\t\t\t\tif( roleA[ orderBy ].toLowerCase() < roleB[ orderBy ].toLowerCase() ) return ascending ? 1 : - 1;\n\t\t\t} else {\n\t\t\t\tif( roleA[ orderBy ] > roleB[ orderBy ] ) return ascending ? - 1 : 1;\n\t\t\t\tif( roleA[ orderBy ] < roleB[ orderBy ] ) return ascending ? 1 : - 1;\n\t\t\t}\n\t\t\treturn 0;\n\t\t} );\n\t}\n}\n\nexport default RolesService;"]}
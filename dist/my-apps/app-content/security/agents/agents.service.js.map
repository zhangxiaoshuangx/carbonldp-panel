{"version":3,"sources":["my-apps/app-content/security/agents/agents.service.ts"],"names":[],"mappings":"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","file":"agents.service.js","sourcesContent":["import { Injectable, EventEmitter } from \"@angular/core\";\r\n\r\nimport Carbon from \"carbonldp/Carbon\";\r\nimport * as App from \"carbonldp/App\";\r\nimport * as Agent from \"carbonldp/Auth/Agent\";\r\nimport * as Agents from \"carbonldp/Auth/Agents\";\r\nimport * as PersistedAgent from \"carbonldp/Auth/PersistedAgent\";\r\nimport * as HTTP from \"carbonldp/HTTP\";\r\nimport * as Utils from \"carbonldp/Utils\";\r\nimport * as URI from \"carbonldp/RDF/URI\";\r\nimport * as NS from \"carbonldp/NS\";\r\nimport * as SPARQL from \"carbonldp/SPARQL\";\r\nimport { Class as RetrievalPreferences, OrderByProperty } from \"carbonldp/RetrievalPreferences\";\r\nimport { AppContentService } from \"carbonldp-panel/my-apps/app-content/app-content.service\";\r\n\r\n@Injectable()\r\nexport class AgentsService {\r\n\r\n\tprivate carbon:Carbon;\r\n\tpublic appContextsAgents:Map<string, Map<string, PersistedAgent.Class>>;\r\n\tprivate appContentService:AppContentService;\r\n\tprivate _activeAgent:PersistedAgent.Class;\r\n\tpublic set activeAgent( app:PersistedAgent.Class ) {\r\n\t\tthis._activeAgent = app;\r\n\t\tthis.onAgentHasChanged.emit( this.activeAgent );\r\n\t}\r\n\r\n\tpublic get activeAgent():PersistedAgent.Class {\r\n\t\treturn this._activeAgent;\r\n\t}\r\n\r\n\tpublic onAgentHasChanged:EventEmitter<PersistedAgent.Class> = new EventEmitter<App.Class>();\r\n\r\n\tconstructor( carbon:Carbon, appContentService:AppContentService ) {\r\n\t\tthis.carbon = carbon;\r\n\t\tthis.appContextsAgents = new Map<string, Map<string, PersistedAgent.Class>>();\r\n\t\tthis.appContentService = appContentService;\r\n\t}\r\n\r\n\tpublic get( slugOrURI:string, appContext:App.Context ):Promise<PersistedAgent.Class> {\r\n\t\tlet uri:string = appContext.getBaseURI() + `agents/${slugOrURI}/`;\r\n\t\tif( URI.Util.isAbsolute( slugOrURI ) ) uri = slugOrURI;\r\n\t\tlet existingAgents:Map <string, PersistedAgent.Class> = this.appContextsAgents.get( appContext.getBaseURI() );\r\n\t\texistingAgents = typeof existingAgents === \"undefined\" ? new Map<string, PersistedAgent.Class>() : existingAgents;\r\n\t\treturn appContext.documents.get<PersistedAgent.Class>( uri ).then( ( [ agent, response ]:[ PersistedAgent.Class, HTTP.Response.Class ] ) => {\r\n\t\t\texistingAgents.set( agent.id, agent );\r\n\t\t\treturn agent;\r\n\t\t} );\r\n\t}\r\n\r\n\tpublic getAll( appContext:App.Context, limit?:number, page?:number, orderBy?:string, ascending:boolean = true ):Promise<PersistedAgent.Class[]> {\r\n\t\tlet uri:string = appContext.getBaseURI() + \"agents/\",\r\n\t\t\texistingAgents:Map <string, PersistedAgent.Class> = this.appContextsAgents.get( appContext.getBaseURI() );\r\n\t\texistingAgents = typeof existingAgents === \"undefined\" ? new Map<string, PersistedAgent.Class>() : existingAgents;\r\n\r\n\t\tlet preferences:RetrievalPreferences = {},\r\n\t\t\tproperty:OrderByProperty,\r\n\t\t\tname:OrderByProperty = {\r\n\t\t\t\t\"@id\": NS.CS.Predicate.namae,\r\n\t\t\t\t\"@type\": \"string\",\r\n\t\t\t},\r\n\t\t\temail:OrderByProperty = {\r\n\t\t\t\t\"@id\": NS.VCARD.Predicate.email,\r\n\t\t\t\t\"@type\": \"string\",\r\n\t\t\t},\r\n\t\t\tcreated:OrderByProperty = {\r\n\t\t\t\t\"@id\": NS.C.Predicate.created,\r\n\t\t\t\t\"@type\": \"dateTime\",\r\n\t\t\t},\r\n\t\t\tmodified:OrderByProperty = {\r\n\t\t\t\t\"@id\": NS.C.Predicate.modified,\r\n\t\t\t\t\"@type\": \"dateTime\",\r\n\t\t\t};\r\n\t\tswitch( orderBy ) {\r\n\t\t\tcase \"name\":\r\n\t\t\t\tproperty = name;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"email\":\r\n\t\t\t\tproperty = email;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"created\":\r\n\t\t\t\tproperty = created;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"modified\":\r\n\t\t\t\tproperty = modified;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\tif( ! orderBy ) preferences.orderBy = [ property ];\r\n\t\tif( ! ascending ) property[ \"@id\" ] = \"-\" + property[ \"@id\" ];\r\n\t\tif( typeof limit !== \"undefined\" ) preferences.limit = limit;\r\n\t\tif( typeof page !== \"undefined\" ) preferences.offset = page * limit;\r\n\r\n\r\n\t\treturn this.carbon.documents.getMembers<PersistedAgent.Class>( uri, false, preferences ).then( ( [ agents, response ]:[ PersistedAgent.Class[], HTTP.Response.Class ] ) => {\r\n\t\t\tagents.filter( ( agent:PersistedAgent.Class ) => ! existingAgents.has( agent.id ) )\r\n\t\t\t\t.forEach( ( agent:PersistedAgent.Class ) => existingAgents.set( agent.id, agent ) );\r\n\r\n\t\t\tlet agentsArray:PersistedAgent.Class[] = Utils.A.from( existingAgents.values() );\r\n\t\t\tif( orderBy ) agentsArray = this.getSortedAgents( agentsArray, orderBy, ascending );\r\n\r\n\t\t\treturn agentsArray;\r\n\t\t} );\r\n\t}\r\n\r\n\tpublic getNumberOfAgents( appContext:App.Context ):Promise<number> {\r\n\t\tlet agentsURI:string = appContext.getBaseURI() + \"agents/\",\r\n\t\t\tquery:string = `SELECT DISTINCT (COUNT(?agent) AS ?count) WHERE {\r\n\t\t\t?agent a <https://carbonldp.com/ns/v1/security#Agent> . \r\n\t\t}`;\r\n\t\treturn appContext.documents.executeSELECTQuery( agentsURI, query ).then( ( [ results, response ]:[ SPARQL.SELECTResults.Class, HTTP.Response.Class ] ) => {\r\n\t\t\tif( typeof results.bindings[ 0 ] === \"undefined\" ) return 0;\r\n\t\t\treturn results.bindings[ 0 ][ \"count\" ];\r\n\t\t} );\r\n\t}\r\n\r\n\tpublic saveAgent( appContext:App.Context, agent:PersistedAgent.Class ):Promise<[ PersistedAgent.Class, HTTP.Response.Class ]> {\r\n\t\treturn agent.save();\r\n\t}\r\n\r\n\tpublic saveAndRefreshAgent( appContext:App.Context, agent:PersistedAgent.Class ):Promise<[ PersistedAgent.Class, [ HTTP.Response.Class, HTTP.Response.Class ] ]> {\r\n\t\treturn agent.saveAndRefresh();\r\n\t}\r\n\r\n\tpublic createAgent( appContext:App.Context, agent:Agent.Class, slug?:string ):Promise<[ PersistedAgent.Class, HTTP.Response.Class ]> {\r\n\t\tlet agents:Agents.Class = appContext.auth.agents;\r\n\t\treturn agents.register( agent, slug );\r\n\t}\r\n\r\n\tpublic deleteAgent( appContext:App.Context, agent:Agent.Class, slug?:string ):Promise<HTTP.Response.Class> {\r\n\t\tlet agents:Agents.Class = appContext.auth.agents;\r\n\t\treturn agents.delete( agent.id );\r\n\t}\r\n\r\n\tprivate getSortedAgents( agents:PersistedAgent.Class[], orderBy:string, ascending:boolean ):PersistedAgent.Class[] {\r\n\t\treturn agents.sort( ( agentA, agentB ) => {\r\n\t\t\tif( typeof agentA[ orderBy ] === \"string\" && typeof agentB[ orderBy ] === \"string\" ) {\r\n\t\t\t\tif( agentA[ orderBy ].toLowerCase() > agentB[ orderBy ].toLowerCase() ) return ascending ? - 1 : 1;\r\n\t\t\t\tif( agentA[ orderBy ].toLowerCase() < agentB[ orderBy ].toLowerCase() ) return ascending ? 1 : - 1;\r\n\t\t\t} else {\r\n\t\t\t\tif( agentA[ orderBy ] > agentB[ orderBy ] ) return ascending ? - 1 : 1;\r\n\t\t\t\tif( agentA[ orderBy ] < agentB[ orderBy ] ) return ascending ? 1 : - 1;\r\n\t\t\t}\r\n\t\t\treturn 0;\r\n\t\t} );\r\n\t}\r\n}\r\n\r\nexport default AgentsService;"]}
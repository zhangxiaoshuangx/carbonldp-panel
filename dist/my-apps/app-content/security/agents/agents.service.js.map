{"version":3,"sources":["my-apps/app-content/security/agents/agents.service.ts"],"names":[],"mappings":"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","file":"agents.service.js","sourcesContent":["import { Injectable, EventEmitter } from \"@angular/core\";\n\nimport Carbon from \"carbonldp/Carbon\";\nimport * as App from \"carbonldp/App\";\nimport * as Agent from \"carbonldp/Auth/Agent\";\nimport * as Agents from \"carbonldp/Auth/Agents\";\nimport * as PersistedAgent from \"carbonldp/Auth/PersistedAgent\";\nimport * as HTTP from \"carbonldp/HTTP\";\nimport * as Utils from \"carbonldp/Utils\";\nimport * as URI from \"carbonldp/RDF/URI\";\nimport * as NS from \"carbonldp/NS\";\nimport * as SPARQL from \"carbonldp/SPARQL\";\nimport { Class as RetrievalPreferences, OrderByProperty } from \"carbonldp/RetrievalPreferences\";\nimport { AppContentService } from \"carbonldp-panel/my-apps/app-content/app-content.service\";\n\n@Injectable()\nexport class AgentsService {\n\n\tprivate carbon:Carbon;\n\tpublic appContextsAgents:Map<string, Map<string, PersistedAgent.Class>>;\n\tprivate appContentService:AppContentService;\n\tprivate _activeAgent:PersistedAgent.Class;\n\tpublic set activeAgent( app:PersistedAgent.Class ) {\n\t\tthis._activeAgent = app;\n\t\tthis.onAgentHasChanged.emit( this.activeAgent );\n\t}\n\n\tpublic get activeAgent():PersistedAgent.Class {\n\t\treturn this._activeAgent;\n\t}\n\n\tpublic onAgentHasChanged:EventEmitter<PersistedAgent.Class> = new EventEmitter<App.Class>();\n\n\tconstructor( carbon:Carbon, appContentService:AppContentService ) {\n\t\tthis.carbon = carbon;\n\t\tthis.appContextsAgents = new Map<string, Map<string, PersistedAgent.Class>>();\n\t\tthis.appContentService = appContentService;\n\t}\n\n\tpublic get( slugOrURI:string, appContext:App.Context ):Promise<PersistedAgent.Class> {\n\t\tlet uri:string = appContext.getBaseURI() + `agents/${slugOrURI}/`;\n\t\tif( URI.Util.isAbsolute( slugOrURI ) ) uri = slugOrURI;\n\t\tlet existingAgents:Map <string, PersistedAgent.Class> = this.appContextsAgents.get( appContext.getBaseURI() );\n\t\texistingAgents = typeof existingAgents === \"undefined\" ? new Map<string, PersistedAgent.Class>() : existingAgents;\n\t\treturn appContext.documents.get<PersistedAgent.Class>( uri ).then( ( [ agent, response ]:[ PersistedAgent.Class, HTTP.Response.Class ] ) => {\n\t\t\texistingAgents.set( agent.id, agent );\n\t\t\treturn agent;\n\t\t} );\n\t}\n\n\tpublic getAll( appContext:App.Context, limit?:number, page?:number, orderBy?:string, ascending:boolean = true ):Promise<PersistedAgent.Class[]> {\n\t\tlet uri:string = appContext.getBaseURI() + \"agents/\",\n\t\t\texistingAgents:Map <string, PersistedAgent.Class> = this.appContextsAgents.get( appContext.getBaseURI() );\n\t\texistingAgents = typeof existingAgents === \"undefined\" ? new Map<string, PersistedAgent.Class>() : existingAgents;\n\n\t\tlet preferences:RetrievalPreferences = {},\n\t\t\tproperty:OrderByProperty,\n\t\t\tname:OrderByProperty = {\n\t\t\t\t\"@id\": NS.CS.Predicate.namae,\n\t\t\t\t\"@type\": \"string\",\n\t\t\t},\n\t\t\temail:OrderByProperty = {\n\t\t\t\t\"@id\": NS.VCARD.Predicate.email,\n\t\t\t\t\"@type\": \"string\",\n\t\t\t},\n\t\t\tcreated:OrderByProperty = {\n\t\t\t\t\"@id\": NS.C.Predicate.created,\n\t\t\t\t\"@type\": \"dateTime\",\n\t\t\t},\n\t\t\tmodified:OrderByProperty = {\n\t\t\t\t\"@id\": NS.C.Predicate.modified,\n\t\t\t\t\"@type\": \"dateTime\",\n\t\t\t};\n\t\tswitch( orderBy ) {\n\t\t\tcase \"name\":\n\t\t\t\tproperty = name;\n\t\t\t\tbreak;\n\t\t\tcase \"email\":\n\t\t\t\tproperty = email;\n\t\t\t\tbreak;\n\t\t\tcase \"created\":\n\t\t\t\tproperty = created;\n\t\t\t\tbreak;\n\t\t\tcase \"modified\":\n\t\t\t\tproperty = modified;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tproperty = name;\n\t\t\t\tbreak;\n\t\t}\n\t\tif( ! orderBy ) preferences.orderBy = [ property ];\n\t\tif( ! ascending ) property[ \"@id\" ] = \"-\" + property[ \"@id\" ];\n\t\tif( typeof limit !== \"undefined\" ) preferences.limit = limit;\n\t\tif( typeof page !== \"undefined\" ) preferences.offset = page * limit;\n\n\n\t\treturn this.carbon.documents.getMembers<PersistedAgent.Class>( uri, false, preferences ).then( ( [ agents, response ]:[ PersistedAgent.Class[], HTTP.Response.Class ] ) => {\n\t\t\tagents.filter( ( agent:PersistedAgent.Class ) => ! existingAgents.has( agent.id ) )\n\t\t\t\t.forEach( ( agent:PersistedAgent.Class ) => existingAgents.set( agent.id, agent ) );\n\n\t\t\tlet agentsArray:PersistedAgent.Class[] = Utils.A.from( existingAgents.values() );\n\t\t\tif( orderBy ) agentsArray = this.getSortedAgents( agentsArray, orderBy, ascending );\n\n\t\t\treturn agentsArray;\n\t\t} );\n\t}\n\n\tpublic getNumberOfAgents( appContext:App.Context ):Promise<number> {\n\t\tlet agentsURI:string = appContext.getBaseURI() + \"agents/\",\n\t\t\tquery:string = `SELECT DISTINCT (COUNT(?agent) AS ?count) WHERE {\n\t\t\t?agent a <https://carbonldp.com/ns/v1/security#Agent> . \n\t\t}`;\n\t\treturn appContext.documents.executeSELECTQuery( agentsURI, query ).then( ( [ results, response ]:[ SPARQL.SELECTResults.Class, HTTP.Response.Class ] ) => {\n\t\t\tif( typeof results.bindings[ 0 ] === \"undefined\" ) return 0;\n\t\t\treturn results.bindings[ 0 ][ \"count\" ];\n\t\t} );\n\t}\n\n\tpublic saveAgent( appContext:App.Context, agent:PersistedAgent.Class ):Promise<[ PersistedAgent.Class, HTTP.Response.Class ]> {\n\t\treturn agent.save();\n\t}\n\n\tpublic saveAndRefreshAgent( appContext:App.Context, agent:PersistedAgent.Class ):Promise<[ PersistedAgent.Class, [ HTTP.Response.Class, HTTP.Response.Class ] ]> {\n\t\treturn agent.saveAndRefresh();\n\t}\n\n\tpublic createAgent( appContext:App.Context, agent:Agent.Class, slug?:string ):Promise<[ PersistedAgent.Class, HTTP.Response.Class ]> {\n\t\tlet agents:Agents.Class = appContext.auth.agents;\n\t\treturn agents.register( agent, slug );\n\t}\n\n\tpublic deleteAgent( appContext:App.Context, agent:Agent.Class, slug?:string ):Promise<HTTP.Response.Class> {\n\t\tlet agents:Agents.Class = appContext.auth.agents;\n\t\treturn agents.delete( agent.id );\n\t}\n\n\tprivate getSortedAgents( agents:PersistedAgent.Class[], orderBy:string, ascending:boolean ):PersistedAgent.Class[] {\n\t\treturn agents.sort( ( agentA, agentB ) => {\n\t\t\tif( typeof agentA[ orderBy ] === \"string\" && typeof agentB[ orderBy ] === \"string\" ) {\n\t\t\t\tif( agentA[ orderBy ].toLowerCase() > agentB[ orderBy ].toLowerCase() ) return ascending ? - 1 : 1;\n\t\t\t\tif( agentA[ orderBy ].toLowerCase() < agentB[ orderBy ].toLowerCase() ) return ascending ? 1 : - 1;\n\t\t\t} else {\n\t\t\t\tif( agentA[ orderBy ] > agentB[ orderBy ] ) return ascending ? - 1 : 1;\n\t\t\t\tif( agentA[ orderBy ] < agentB[ orderBy ] ) return ascending ? 1 : - 1;\n\t\t\t}\n\t\t\treturn 0;\n\t\t} );\n\t}\n}\n\nexport default AgentsService;"]}